{% extends "base.html" %}
{% block content %}
  <div class="row">
    <div>
      <h2>Артефакты организации: {{ org_name }}</h2>
      <div class="muted">
        Заполнено: <b>{{ completion_uploaded }}</b> из <b>{{ completion_total }}</b> ({{ completion_pct }}%) · осталось {{ completion_total - completion_uploaded }}
      </div>
    </div>
    <div class="row-right">
      {% if orgs and orgs|length > 1 %}
        <form method="get" action="/my/artifacts" style="display:inline">
          <select name="org_id" data-org-autocomplete="1" data-auto-submit="1" data-placeholder="Поиск организации…">
            {% for o in orgs %}
              <option value="{{ o.id }}" {% if o.id == selected_org_id %}selected{% endif %}>{{ o.name }}</option>
            {% endfor %}
          </select>
        </form>
      {% endif %}
      <a class="btn btn-secondary" href="/my/index-kb?org_id={{ selected_org_id }}">Индекс ИБ</a>
      <a class="btn btn-secondary" href="/my/files">К файлам</a>
    </div>
  </div>

  <div class="card">
    <form method="get" action="/my/artifacts" class="grid filter-form filter-form--status">
      <input type="hidden" name="org_id" value="{{ selected_org_id }}" />
      <div class="filter-q">
        <label>Поиск (показатель/артефакт)</label>
        <input name="q" value="{{ q or '' }}" placeholder="например: лицензии / конфигурации" />
      </div>
      <div class="filter-topic">
        <label>Тематика</label>
        <select name="topic">
          <option value="">(все)</option>
          {% for t in topics %}
            <option value="{{ t }}" {% if t == topic %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-domain">
        <label>Домен</label>
        <select name="domain">
          <option value="">(все)</option>
          {% for d in domains %}
            <option value="{{ d }}" {% if d == domain %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-kb">
        <label>Уровень КБ</label>
        <select name="kb_level">
          <option value="">(все)</option>
          {% for k in kb_levels %}
            <option value="{{ k }}" {% if k == kb_level %}selected{% endif %}>{{ k }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-status">
        <label>Статус</label>
        <select name="status">
          <option value="" {% if not status %}selected{% endif %}>(все)</option>
          <option value="missing" {% if status == "missing" %}selected{% endif %}>Не загружен</option>
          <option value="uploaded" {% if status == "uploaded" %}selected{% endif %}>Загружен</option>
        </select>
      </div>
      <div class="filter-status">
        <label>Аудит</label>
        <select name="audit">
          <option value="" {% if not audit %}selected{% endif %}>(все)</option>
          <option value="needs" {% if audit == "needs" %}selected{% endif %}>Требует аудита</option>
          <option value="needs_correction" {% if audit == "needs_correction" %}selected{% endif %}>Требует корректировки</option>
          <option value="audited" {% if audit == "audited" %}selected{% endif %}>Проаудировано</option>
          <option value="changed" {% if audit == "changed" %}selected{% endif %}>Изменён</option>
        </select>
      </div>
      <div class="filter-short">
        <label>Сокращенное наименование (точно)</label>
        <input name="short_name" value="{{ short_name or '' }}" placeholder="например: СЗИ.2FA.1" />
      </div>
      <div class="filter-actions">
        <button class="btn" type="submit">Применить фильтры</button>
      </div>
      <div class="filter-meta">
        {% if org_level %}
          <span class="muted filter-meta__nowrap">Уровень: <b>{{ org_level.name }}</b></span>
        {% endif %}
        <label class="muted filter-meta__nowrap filter-meta__label">
          <span>Период</span>
          <select name="period_id" onchange="this.form.submit()" style="width: 260px;">
            {% for p in periods %}
              <option value="{{ p.id }}" {% if p.id == selected_period_id %}selected{% endif %}>{{ p.name }} ({{ p.date_from|d }} — {{ p.date_to|d }})</option>
            {% endfor %}
          </select>
        </label>
        <label class="filter-meta__label filter-meta__nowrap" style="user-select:none">
          <input type="checkbox" name="in_period" value="1" {% if in_period %}checked{% endif %} onchange="this.form.submit()" />
          <span>Только загруженные в период</span>
        </label>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>Таблица</h3>
      <div class="muted">Показано {{ rows|length }} из {{ total }} · страница {{ page }}</div>
      <div class="row-right">
        {% if has_prev %}
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page - 1 }}">← Назад</a>
        {% endif %}
        {% if has_next %}
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page + 1 }}">Вперёд →</a>
        {% endif %}
      </div>
    </div>
    <div class="table-wrap">
      <table class="table table-fixed table-customer-artifacts">
        <thead>
          <tr>
            <th>Тематика</th>
            <th>Домен</th>
            <th>Показатель</th>
            <th>Сокращенное</th>
            <th>Пункт</th>
            <th>КБ</th>
            <th>Артефакт</th>
            <th class="col-status">Статус</th>
            <th class="col-status">Аудит</th>
            <th>Файл</th>
            <th>Загрузить</th>
            <th class="th-actions-wide"></th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.a.topic }}</td>
              <td>{{ r.a.domain }}</td>
              <td class="cell-wrap">{{ r.a.indicator_name }}</td>
              <td class="mono">{{ r.a.short_name }}</td>
              <td class="mono">{% if r.a.achievement_item_no %}{{ r.a.achievement_item_no }}{% else %}—{% endif %}</td>
              <td>{{ r.a.kb_level }}</td>
              <td class="cell-wrap">{{ r.a.title }}</td>
              <td class="col-status">
                {% if r.oa.status.value == "uploaded" %}
                  <span
                    class="badge"
                    {% if r.comment_text %}
                      title="Комментарий аудитора: {{ r.comment_by }} · {{ r.comment_at|dt }}&#10;{{ r.comment_text|replace('\n',' ') }}"
                    {% endif %}
                  >Загружен</span>
                {% else %}
                  <span
                    class="badge badge-danger"
                    {% if r.comment_text %}
                      title="Комментарий аудитора: {{ r.comment_by }} · {{ r.comment_at|dt }}&#10;{{ r.comment_text|replace('\n',' ') }}"
                    {% endif %}
                  >Не загружен</span>
                {% endif %}
              </td>
              <td class="col-status">
                <span
                  class="{{ r.audit_class }}"
                  {% if r.comment_text %}
                    title="Комментарий аудитора: {{ r.comment_by }} · {{ r.comment_at|dt }}&#10;{{ r.comment_text|replace('\n',' ') }}"
                  {% endif %}
                >{{ r.audit_label }}</span>
                {% if r.audit_label == "Проаудировано" and r.oa.audited_at %}
                  <div class="muted mono" style="margin-top:4px">{{ r.oa.audited_at|dt }}{% if r.audited_by %} · {{ r.audited_by }}{% endif %}</div>
                {% endif %}
              </td>
              <td class="mono cell-wrap">
                {% if r.fv_period %}
                  v{{ r.fv_period.version_no }} · {{ r.fv_period.original_filename }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                <form method="post" action="/my/artifacts/{{ r.oa.id }}/upload" enctype="multipart/form-data">
                  <div class="upload-row">
                    <input class="file-input" name="upload" type="file" required />
                    <button class="icon-btn icon-success" type="submit" title="Загрузить" aria-label="Загрузить">
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M5 18v2h14v-2H5zM12 3l7 7h-4v6H9v-6H5l7-7z"/>
                      </svg>
                    </button>
                  </div>
                  <div class="file-name muted"></div>
                </form>
              </td>
              <td class="td-actions-wide">
                {% if r.oa.status.value == "uploaded" %}
                  <div class="row-right" style="justify-content:flex-end">
                    <a class="icon-btn" href="/my/artifacts/{{ r.oa.id }}/download" title="Скачать" aria-label="Скачать">
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M5 18v2h14v-2H5zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                      </svg>
                    </a>
                    <form method="post" action="/my/artifacts/{{ r.oa.id }}/delete" onsubmit="return confirm('Удалить файл из артефакта? Статус станет \"Не загружен\". История версий сохранится.');" style="display:inline">
                      <button class="icon-btn icon-danger" type="submit" title="Удалить" aria-label="Удалить">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                          <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm-2 4h10l-1 14H8L7 7zm3 3h2v9h-2v-9zm4 0h2v9h-2v-9z"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          {% if rows|length == 0 %}
            <tr>
              <td colspan="12" class="muted">
                {% if in_period %}
                  В выбранном периоде нет загруженных файлов (или загрузки не попали в период).
                {% else %}
                  Нет артефактов по выбранным фильтрам.
                {% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    <div class="pagination">
      <div class="muted">Страница {{ page }} из {{ total_pages }}</div>
      <div class="pagination-links">
        {% if has_prev %}
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page=1">⟪</a>
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page - 1 }}">←</a>
        {% else %}
          <span class="btn btn-secondary" aria-disabled="true">⟪</span>
          <span class="btn btn-secondary" aria-disabled="true">←</span>
        {% endif %}

        {% if page_links[0] > 1 %}
          <span class="muted">…</span>
        {% endif %}
        {% for p in page_links %}
          {% if p == page %}
            <span class="page-chip page-chip-active">{{ p }}</span>
          {% else %}
            <a class="page-chip" href="/my/artifacts?{{ base_query }}&page={{ p }}">{{ p }}</a>
          {% endif %}
        {% endfor %}
        {% if page_links[-1] < total_pages %}
          <span class="muted">…</span>
        {% endif %}

        {% if has_next %}
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page + 1 }}">→</a>
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ total_pages }}">⟫</a>
        {% else %}
          <span class="btn btn-secondary" aria-disabled="true">→</span>
          <span class="btn btn-secondary" aria-disabled="true">⟫</span>
        {% endif %}
      </div>

      <form class="pagination-jump" method="get" action="/my/artifacts">
        <input type="hidden" name="topic" value="{{ topic or '' }}" />
        <input type="hidden" name="domain" value="{{ domain or '' }}" />
        <input type="hidden" name="kb_level" value="{{ kb_level or '' }}" />
        <input type="hidden" name="short_name" value="{{ short_name or '' }}" />
        <input type="hidden" name="q" value="{{ q or '' }}" />
        <input type="hidden" name="status" value="{{ status or '' }}" />
        <input type="hidden" name="period_id" value="{{ selected_period_id }}" />
        {% if in_period %}
          <input type="hidden" name="in_period" value="1" />
        {% endif %}
        <label style="margin:0">Строк на страницу</label>
        <select name="page_size" onchange="this.form.page.value=1; this.form.submit()" style="width: 140px;">
          {% for s in [10,20,50,100,200] %}
            <option value="{{ s }}" {% if s == page_size %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
        <label style="margin:0">Перейти</label>
        <input name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" style="width: 110px" />
        <button class="btn btn-secondary" type="submit">Ок</button>
      </form>
    </div>
  </div>
{% endblock %}

