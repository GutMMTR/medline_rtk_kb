{% extends "base.html" %}
{% block content %}
  <div class="row">
    <div>
      <h2>Артефакты организации: {{ org_name }}</h2>
      <div class="muted">
        Заполнено: <b>{{ completion_uploaded }}</b> из <b>{{ completion_total }}</b> ({{ completion_pct }}%) · осталось {{ completion_total - completion_uploaded }}
      </div>
    </div>
    <div class="row-right">
      <a class="btn btn-secondary" href="/my/files">К файлам</a>
    </div>
  </div>

  <div class="card">
    <form method="get" action="/my/artifacts" class="grid filter-form filter-form--status">
      <div class="filter-q">
        <label>Поиск (показатель/артефакт)</label>
        <input name="q" value="{{ q or '' }}" placeholder="например: лицензии / конфигурации" />
      </div>
      <div class="filter-topic">
        <label>Тематика</label>
        <select name="topic">
          <option value="">(все)</option>
          {% for t in topics %}
            <option value="{{ t }}" {% if t == topic %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-domain">
        <label>Домен</label>
        <select name="domain">
          <option value="">(все)</option>
          {% for d in domains %}
            <option value="{{ d }}" {% if d == domain %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-kb">
        <label>Уровень КБ</label>
        <select name="kb_level">
          <option value="">(все)</option>
          {% for k in kb_levels %}
            <option value="{{ k }}" {% if k == kb_level %}selected{% endif %}>{{ k }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-status">
        <label>Статус</label>
        <select name="status">
          <option value="" {% if not status %}selected{% endif %}>(все)</option>
          <option value="missing" {% if status == "missing" %}selected{% endif %}>Не загружен</option>
          <option value="uploaded" {% if status == "uploaded" %}selected{% endif %}>Загружен</option>
        </select>
      </div>
      <div class="filter-short">
        <label>Сокращенное наименование (точно)</label>
        <input name="short_name" value="{{ short_name or '' }}" placeholder="например: СЗИ.2FA.1" />
      </div>
      <div class="filter-actions">
        <button class="btn" type="submit">Применить фильтры</button>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="section-header">
      <h3>Таблица</h3>
      <div class="muted">Показано {{ rows|length }} из {{ total }} · страница {{ page }}</div>
      <div class="row-right">
        {% if has_prev %}
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page - 1 }}">← Назад</a>
        {% endif %}
        {% if has_next %}
          <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page + 1 }}">Вперёд →</a>
        {% endif %}
      </div>
    </div>
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Тематика</th>
            <th>Домен</th>
            <th>Показатель</th>
            <th>Сокращенное</th>
            <th>Пункт</th>
            <th>КБ</th>
            <th>Артефакт</th>
            <th class="col-status">Статус</th>
            <th>Файл</th>
            <th>Загрузить</th>
            <th class="th-actions-wide"></th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.a.topic }}</td>
              <td>{{ r.a.domain }}</td>
              <td style="min-width:260px">{{ r.a.indicator_name }}</td>
              <td class="mono">{{ r.a.short_name }}</td>
              <td class="mono">{% if r.a.achievement_item_no %}{{ r.a.achievement_item_no }}{% else %}—{% endif %}</td>
              <td>{{ r.a.kb_level }}</td>
              <td style="min-width:260px">{{ r.a.title }}</td>
              <td class="col-status">
                {% if r.oa.status.value == "uploaded" %}
                  <span class="badge">Загружен</span>
                {% else %}
                  <span class="badge badge-danger">Не загружен</span>
                {% endif %}
              </td>
              <td class="mono">
                {% if r.fv %}
                  v{{ r.fv.version_no }} · {{ r.fv.original_filename }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td>
                <form method="post" action="/my/artifacts/{{ r.oa.id }}/upload" enctype="multipart/form-data">
                  <div class="upload-row">
                    <input class="file-input" name="upload" type="file" required />
                    <button class="btn" type="submit">Загрузить</button>
                  </div>
                  <div class="hint">лимит {{ max_upload_mb }} МБ</div>
                </form>
              </td>
              <td class="td-actions-wide">
                {% if r.oa.status.value == "uploaded" %}
                  <div class="row-right" style="justify-content:flex-end">
                    <a class="icon-btn" href="/my/artifacts/{{ r.oa.id }}/download" title="Скачать" aria-label="Скачать">
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M5 20h14v-2H5v2zm7-18-5.5 5.5 1.42 1.42L11 6.84V16h2V6.84l3.08 3.08 1.42-1.42L12 2z"/>
                      </svg>
                    </a>
                    <form method="post" action="/my/artifacts/{{ r.oa.id }}/delete" onsubmit="return confirm('Удалить файл из артефакта? Статус станет \"Не загружен\". История версий сохранится.');" style="display:inline">
                      <button class="icon-btn icon-danger" type="submit" title="Удалить" aria-label="Удалить">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                          <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                      </button>
                    </form>
                  </div>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          {% if rows|length == 0 %}
            <tr><td colspan="11" class="muted">Нет артефактов. Попросите администратора импортировать справочник.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    {% if has_prev or has_next %}
      <div class="pagination">
        <div class="muted">Страница {{ page }} из {{ total_pages }}</div>
        <div class="pagination-links">
          {% if has_prev %}
            <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page=1">⟪</a>
            <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page - 1 }}">←</a>
          {% endif %}

          {% if page_links[0] > 1 %}
            <span class="muted">…</span>
          {% endif %}
          {% for p in page_links %}
            {% if p == page %}
              <span class="page-chip page-chip-active">{{ p }}</span>
            {% else %}
              <a class="page-chip" href="/my/artifacts?{{ base_query }}&page={{ p }}">{{ p }}</a>
            {% endif %}
          {% endfor %}
          {% if page_links[-1] < total_pages %}
            <span class="muted">…</span>
          {% endif %}

          {% if has_next %}
            <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ page + 1 }}">→</a>
            <a class="btn btn-secondary" href="/my/artifacts?{{ base_query }}&page={{ total_pages }}">⟫</a>
          {% endif %}
        </div>

        <form class="pagination-jump" method="get" action="/my/artifacts">
          <input type="hidden" name="topic" value="{{ topic or '' }}" />
          <input type="hidden" name="domain" value="{{ domain or '' }}" />
          <input type="hidden" name="kb_level" value="{{ kb_level or '' }}" />
          <input type="hidden" name="short_name" value="{{ short_name or '' }}" />
          <input type="hidden" name="q" value="{{ q or '' }}" />
          <input type="hidden" name="status" value="{{ status or '' }}" />
          <input type="hidden" name="page_size" value="{{ page_size }}" />
          <label style="margin:0">Перейти</label>
          <input name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" style="width: 110px" />
          <button class="btn btn-secondary" type="submit">Ок</button>
        </form>
      </div>
    {% endif %}
  </div>
{% endblock %}

