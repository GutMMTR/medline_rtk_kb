{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <div>
      <h2 style="margin:0">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ¬∑ Nextcloud</h2>
      <div class="muted">–ò–º–ø–æ—Ä—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏–∑ Nextcloud –ø–æ WebDAV. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: <span class="mono">ROOT/–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/SHORT.NAME/PATH/—Ñ–∞–π–ª—ã</span>.</div>
    </div>
    <div class="row-right">
      <a class="btn btn-secondary" href="/admin">–ù–∞–∑–∞–¥</a>
    </div>
  </div>

  <div class="card">
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
    {% if ok %}
      <div class="inline-status">{{ ok }}</div>
    {% endif %}
    <div id="nc-status" class="inline-status inline-status--loading" style="display:none" aria-live="polite"></div>

    <form method="post" action="/admin/integrations/nextcloud/save" class="grid" data-action-label="–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫">
      <div>
        <label>Base URL</label>
        <input name="base_url" value="{{ s.base_url }}" placeholder="https://nextcloud.soc.rt.ru" required />
      </div>
      <div>
        <label>–õ–æ–≥–∏–Ω</label>
        <input name="username" value="{{ s.username }}" required />
      </div>
      <div>
        <label>–ü–∞—Ä–æ–ª—å / App password</label>
        <input name="password" type="password" value="{{ s.password }}" required />
        <div class="hint">MVP: —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å app password.</div>
      </div>
      <div>
        <label>–ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞ (–≤ –æ–±–ª–∞–∫–µ)</label>
        <input name="root_folder" value="{{ s.root_folder }}" placeholder="(–ø—É—Å—Ç–æ = –∫–æ—Ä–µ–Ω—å)" />
      </div>
      <div>
        <label>–°–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –ø–∞–ø–æ–∫</label>
        <select name="create_orgs">
          <option value="true" {% if s.create_orgs %}selected{% endif %}>–¥–∞</option>
          <option value="false" {% if not s.create_orgs %}selected{% endif %}>–Ω–µ—Ç</option>
        </select>
      </div>
      <div>
        <label>–í–∫–ª—é—á–µ–Ω–æ</label>
        <select name="is_enabled">
          <option value="true" {% if s.is_enabled %}selected{% endif %}>–¥–∞</option>
          <option value="false" {% if not s.is_enabled %}selected{% endif %}>–Ω–µ—Ç</option>
        </select>
      </div>
      <div class="filter-actions" style="grid-column: span 2">
        <button class="btn" type="submit" data-loading-text="–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>

  <div class="card">
    <div class="section-header nc-actions-header">
      <h3 style="margin:0">–î–µ–π—Å—Ç–≤–∏—è</h3>
      <div class="muted">–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {{ s.last_error or "‚Äî" }} ¬∑ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: {{ s.last_sync_at|dt if s.last_sync_at else "‚Äî" }}</div>
    </div>
    <div class="row-right nc-actions-buttons" style="justify-content:flex-start; gap:10px; flex-wrap: wrap;">
      <form method="post" action="/admin/integrations/nextcloud/test" style="display:inline" data-action-label="–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">
        <button class="btn btn-secondary" type="submit" data-loading-text="–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
      </form>
      <form method="post" action="/admin/integrations/nextcloud/discover" style="display:inline" data-action-label="–ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ –æ–±–ª–∞–∫–µ">
        <button class="btn btn-secondary" type="submit" data-loading-text="–ò—â—É‚Ä¶">–û–±–Ω–∞—Ä—É–∂–∏—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</button>
      </form>
      <form method="post" action="/admin/integrations/nextcloud/sync" style="display:inline" data-action-label="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è)" onsubmit="return confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (—Ä–µ–∑–µ—Ä–≤–Ω—É—é)?')">
        <button
          class="btn btn-secondary"
          type="submit"
          data-loading-text="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é‚Ä¶"
          title="V1 (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è): ROOT/<–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è>/–í–°–°–¢/–ö–ú–ù–ö/1/<—Ñ–∞–π–ª> ‚Üí short_name=–í–°–°–¢.–ö–ú–ù–ö.1"
        >–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
      </form>
      <form method="post" action="/admin/integrations/nextcloud/sync-v2" style="display:inline; margin-left:auto" data-action-label="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (03 –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)" onsubmit="return confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (03 –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)?')">
        <button
          class="btn btn-accent"
          type="submit"
          data-loading-text="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é‚Ä¶"
          title="V2 (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): ROOT/<–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è>/03 –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã/<–∫–∞—Ç–µ–≥–æ—Ä–∏—è>/[–ª—é–±—ã–µ_–ø–∞–ø–∫–∏]/<SHORT.NAME –∏–ª–∏ prefix>/<—Ñ–∞–π–ª—ã>. –ü—Ä–∏–º–µ—Ä: ROOT/–¢–µ—Å—Ç–æ–≤–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è 3/03 –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã/06 –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò–ë/–°–£–ò–ë.–£–†–ó/<—Ñ–∞–π–ª> ‚Üí short_name=–°–£–ò–ë.–£–†–ó"
        >–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (03 –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã)</button>
      </form>
    </div>
    {% if discovered_orgs %}
      <div style="margin-top:12px">
        <div class="muted">–ü–∞–ø–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ –æ–±–ª–∞–∫–µ:</div>
        <div class="folder-grid" style="margin-top:8px">
          {% for name in discovered_orgs %}
            <div class="folder-card" style="cursor:default">
              <div class="folder-icon">üìÅ</div>
              <div class="folder-name mono">{{ name }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if stats %}
      <div class="card" style="margin-top:12px">
        <div class="muted">–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:</div>
        <table class="table" style="margin-top:8px">
          <tbody>
            <tr><td>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</td><td class="mono">{{ stats.orgs_seen }}</td></tr>
            <tr><td>–ü–∞–ø–æ–∫ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</td><td class="mono">{{ stats.folders_seen }}</td></tr>
            <tr><td>–§–∞–π–ª–æ–≤ –Ω–∞–π–¥–µ–Ω–æ</td><td class="mono">{{ stats.files_seen }}</td></tr>
            <tr><td>–§–∞–π–ª–æ–≤ —Å–∫–∞—á–∞–Ω–æ</td><td class="mono">{{ stats.files_downloaded }}</td></tr>
            <tr><td>–§–∞–π–ª–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω–æ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ)</td><td class="mono">{{ stats.files_skipped }}</td></tr>
            <tr><td>–°–æ–∑–¥–∞–Ω–æ –≤–µ—Ä—Å–∏–π</td><td class="mono">{{ stats.file_versions_created }}</td></tr>
            <tr><td>–û—à–∏–±–æ–∫</td><td class="mono">{{ stats.errors }}</td></tr>
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <script>
    (function() {
      const status = document.getElementById('nc-status');
      function showStatus(text, kind) {
        if (!status) return;
        status.style.display = 'block';
        status.classList.remove('inline-status--error');
        status.classList.add('inline-status--loading');
        if (kind === 'error') {
          status.classList.remove('inline-status--loading');
          status.classList.add('inline-status--error');
        }
        status.textContent = text;
      }

      const forms = document.querySelectorAll('form[action^="/admin/integrations/nextcloud/"]');
      forms.forEach((form) => {
        form.addEventListener('submit', (e) => {
          if (typeof form.checkValidity === 'function' && !form.checkValidity()) {
            e.preventDefault();
            if (typeof form.reportValidity === 'function') form.reportValidity();
            showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã.', 'error');
            return;
          }

          const label = form.getAttribute('data-action-label') || '–í—ã–ø–æ–ª–Ω—è—é –¥–µ–π—Å—Ç–≤–∏–µ';
          showStatus(label + '‚Ä¶', 'loading');

          const btn = form.querySelector('button[type="submit"]');
          if (btn) {
            btn.dataset._origText = btn.textContent || '';
            const loadingText = btn.getAttribute('data-loading-text') || '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è‚Ä¶';
            btn.textContent = loadingText;
            btn.disabled = true;
            btn.setAttribute('aria-disabled', 'true');
          }

          // Disable all other action buttons to avoid double submits
          document.querySelectorAll('button[type="submit"]').forEach((b) => {
            if (b !== btn) {
              b.disabled = true;
              b.setAttribute('aria-disabled', 'true');
            }
          });
        });
      });
    })();
  </script>
{% endblock %}

