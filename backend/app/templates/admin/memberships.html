{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <div>
      <h2 style="margin:0">Доступы (роли)</h2>
      <div class="muted">Назначение ролей пользователям в организациях.</div>
    </div>
    <div class="row-right"><a class="btn btn-secondary" href="/admin">Назад</a></div>
  </div>

  <div class="card">
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
    <div class="muted" style="margin-bottom:10px">
      Служебная организация <span class="mono">Default</span> и системные привязки скрыты из UI.
    </div>
    <form method="post" action="/admin/memberships" class="grid" style="grid-template-columns: repeat(3, minmax(0, 1fr)); align-items:end;">
      <div>
        <label>Пользователь</label>
        <div class="combo" id="mem_user_combo">
          <input id="mem_user_id" name="user_id" type="hidden" value="" />
          <div class="combo-input-wrap">
            <input
              class="combo-input"
              id="mem_user_input"
              type="text"
              autocomplete="off"
              placeholder="Выберите пользователя…"
              value=""
            />
            <span class="combo-caret" aria-hidden="true">▾</span>
          </div>
          <div class="combo-popover" id="mem_user_pop" hidden>
            <div class="combo-list" id="mem_user_list" role="listbox"></div>
          </div>
        </div>
      </div>
      <div>
        <label>Организация</label>
        <div class="combo" id="mem_org_combo">
          <input id="mem_org_id" name="org_id" type="hidden" value="" />
          <div class="combo-input-wrap">
            <input
              class="combo-input"
              id="mem_org_input"
              type="text"
              autocomplete="off"
              placeholder="Выберите организацию…"
              value=""
            />
            <span class="combo-caret" aria-hidden="true">▾</span>
          </div>
          <div class="combo-popover" id="mem_org_pop" hidden>
            <div class="combo-list" id="mem_org_list" role="listbox"></div>
          </div>
        </div>
      </div>
      <div>
        <label>Роль</label>
        <select name="role">
          {% for r in roles %}
            <option value="{{ r }}">{{ role_labels.get(r, r) }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-actions" style="grid-column: span 3">
        <button class="btn" type="submit">Назначить/обновить</button>
      </div>
    </form>
    <script>
      (function () {
        function initCombo(cfg) {
          const el = document.getElementById(cfg.comboId);
          const pop = document.getElementById(cfg.popId);
          const inp = document.getElementById(cfg.inputId);
          const list = document.getElementById(cfg.listId);
          const hid = document.getElementById(cfg.hiddenId);
          if (!el || !pop || !inp || !list || !hid) return;

          function open() {
            pop.hidden = false;
            render(inp.value || "");
          }
          function close() {
            pop.hidden = true;
          }
          function isOpen() {
            return pop.hidden === false;
          }

          function setSelected(id, label) {
            hid.value = id || "";
            inp.value = label || "";
            close();
          }

          function render(q) {
            const query = (q || "").trim().toLowerCase();
            const items = query
              ? cfg.items.filter(it => (it.label || "").toLowerCase().includes(query))
              : cfg.items;

            list.innerHTML = "";
            const cur = String(hid.value || "");
            for (const it of items) {
              const row = document.createElement("div");
              row.className = "combo-option" + (String(it.id) === cur ? " combo-option--active" : "");
              row.setAttribute("role", "option");
              row.setAttribute("aria-selected", String(it.id) === cur ? "true" : "false");
              row.textContent = it.label;
              row.addEventListener("mousedown", (e) => {
                e.preventDefault();
                setSelected(String(it.id || ""), it.label);
              });
              list.appendChild(row);
            }
          }

          inp.addEventListener("focus", open);
          inp.addEventListener("click", open);
          inp.addEventListener("input", function () {
            // пока пользователь печатает руками — selection сбрасываем до клика по опции
            hid.value = "";
            open();
          });
          inp.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
              e.preventDefault();
              close();
            }
          });
          document.addEventListener("click", function (e) {
            if (!isOpen()) return;
            if (!el.contains(e.target)) close();
          });
        }

        initCombo({
          comboId: "mem_user_combo",
          popId: "mem_user_pop",
          inputId: "mem_user_input",
          listId: "mem_user_list",
          hiddenId: "mem_user_id",
          items: [
            {% for u in system_users %}
              { id: "{{ u.id }}", label: {{ u.login|tojson }} },
            {% endfor %}
            {% for u in users %}
              { id: "{{ u.id }}", label: {{ u.login|tojson }} },
            {% endfor %}
          ],
        });

        initCombo({
          comboId: "mem_org_combo",
          popId: "mem_org_pop",
          inputId: "mem_org_input",
          listId: "mem_org_list",
          hiddenId: "mem_org_id",
          items: [
            {% for o in orgs %}
              { id: "{{ o.id }}", label: {{ o.name|tojson }} },
            {% endfor %}
          ],
        });
      })();
    </script>
  </div>

  <div class="card">
    <div class="section-header">
      <h3 style="margin:0">Системные привязки</h3>
      <div class="muted">Всего: {{ system_memberships|length }}</div>
    </div>
    <div class="table-wrap">
    <table class="table">
      <thead><tr><th>Пользователь</th><th>Организация</th><th>Роль</th><th>Создан</th><th class="th-actions-wide"></th></tr></thead>
      <tbody>
        {% for m in system_memberships %}
          <tr>
            <td>{{ m.user.login if m.user else m.user_id }}</td>
            <td>{{ m.org.name if m.org else m.org_id }}</td>
            <td>{{ role_labels.get(m.role.value if m.role else '', m.role.value if m.role else '') }}</td>
            <td class="mono">{{ m.created_at|dt }}</td>
            <td class="td-actions-wide">
              <div class="row-right" style="justify-content:flex-end; gap:8px;">
                <select aria-disabled="true" disabled style="width: 170px;">
                  <option selected>{{ role_labels.get(m.role.value if m.role else '', m.role.value if m.role else '') }}</option>
                </select>
                <button class="icon-btn" type="button" aria-disabled="true" disabled title="Служебная привязка">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M12 1 3 5v6c0 5 3.8 9.7 9 11 5.2-1.3 9-6 9-11V5l-9-4z"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        {% endfor %}
        {% if system_memberships|length == 0 %}
          <tr><td colspan="5" class="muted">Нет системных привязок.</td></tr>
        {% endif %}
      </tbody>
    </table>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3 style="margin:0">Привязки по организациям</h3>
      <div class="muted">Всего: {{ memberships|length }}</div>
    </div>
    <div class="table-wrap">
    <table class="table">
      <thead><tr><th>Пользователь</th><th>Организация</th><th>Роль</th><th>Создан</th><th class="th-actions-wide"></th></tr></thead>
      <tbody>
        {% for m in memberships %}
          <tr>
            <td>{{ m.user.login if m.user else m.user_id }}</td>
            <td>{{ m.org.name if m.org else m.org_id }}</td>
            <td>{{ role_labels.get(m.role.value if m.role else '', m.role.value if m.role else '') }}</td>
            <td class="mono">{{ m.created_at|dt }}</td>
            <td class="td-actions-wide">
              <form method="post" action="/admin/memberships" class="row-right" style="justify-content:flex-end; gap:8px;">
                <input type="hidden" name="user_id" value="{{ m.user_id }}" />
                <input type="hidden" name="org_id" value="{{ m.org_id }}" />
                <select name="role" style="width: 170px;">
                  {% for r in roles %}
                    <option value="{{ r }}" {% if m.role and m.role.value == r %}selected{% endif %}>{{ role_labels.get(r, r) }}</option>
                  {% endfor %}
                </select>
                <button class="icon-btn" type="submit" title="Сохранить" aria-label="Сохранить">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zM6 8V5h9v3H6z"/>
                    <path fill="currentColor" d="M16 9v6h2l-3 3-3-3h2V9h2z"/>
                  </svg>
                </button>
              </form>
            </td>
          </tr>
        {% endfor %}
        {% if memberships|length == 0 %}
          <tr><td colspan="5" class="muted">Нет привязок по организациям.</td></tr>
        {% endif %}
      </tbody>
    </table>
    </div>
  </div>
{% endblock %}
