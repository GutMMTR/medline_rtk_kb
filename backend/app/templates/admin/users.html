{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <div>
      <h2 style="margin:0">Пользователи</h2>
      <div class="muted">Поиск и управление пользователями (редактирование, блокировка, удаление).</div>
    </div>
    <div class="row-right">
      <a class="btn" href="/admin/users/new">Создать пользователя</a>
      <a class="btn btn-secondary" href="/admin">Назад</a>
    </div>
  </div>

  <div class="card">
    <div class="section-header">
      <h3 style="margin:0">Таблица</h3>
      <div class="muted">Показано {{ users|length }} из {{ total }}</div>
    </div>
    <form method="get" action="/admin/users" class="grid filter-form" style="margin-top: 10px">
      <div class="filter-org" style="grid-column: span 2">
        <label style="margin:0">Организация</label>
        <div class="combo" id="org_combo">
          <input id="org_id" name="org_id" type="hidden" value="{{ selected_org_id or '' }}" />
          <div class="combo-input-wrap">
            <input
              class="combo-input"
              id="org_combo_input"
              type="text"
              autocomplete="off"
              placeholder="(все)"
              value="{% if selected_org_id %}{{ selected_org_name }}{% endif %}"
            />
            <span class="combo-caret" aria-hidden="true">▾</span>
          </div>
          <div class="combo-popover" id="org_combo_pop" hidden>
            <div class="combo-list" id="org_combo_list" role="listbox"></div>
          </div>
        </div>
      </div>

      <div style="grid-column: span 2">
        <label style="margin:0">Логин</label>
        <input name="login" value="{{ filters.login }}" placeholder="поиск…" />
      </div>

      <div style="grid-column: span 2">
        <label style="margin:0">ФИО</label>
        <input name="full_name" value="{{ filters.full_name }}" placeholder="поиск…" />
      </div>

      <div class="filter-actions" style="grid-column: span 6">
        <button class="btn btn-secondary" type="submit">Применить</button>
        <a class="btn btn-secondary" href="/admin/users">Сброс</a>
      </div>

      <input type="hidden" name="page" value="1" />
      <input type="hidden" name="page_size" value="{{ page_size }}" />
      <input type="hidden" name="sort" value="{{ sort }}" />
      <input type="hidden" name="dir" value="{{ dir }}" />
    </form>
    <script>
      (function () {
        const orgs = [
          {% for o in orgs %}
            { id: "{{ o.id }}", name: {{ o.name|tojson }} },
          {% endfor %}
        ];
        const el = document.getElementById("org_combo");
        const pop = document.getElementById("org_combo_pop");
        const inp = document.getElementById("org_combo_input");
        const list = document.getElementById("org_combo_list");
        const hid = document.getElementById("org_id");
        if (!el || !pop || !inp || !list || !hid) return;

        const ALL = { id: "", name: "(все)" };

        function open() {
          pop.hidden = false;
          render(inp.value || "");
        }
        function close() {
          pop.hidden = true;
        }
        function isOpen() {
          return pop.hidden === false;
        }

        function setSelected(id, name) {
          hid.value = id || "";
          inp.value = (name && name !== "(все)") ? name : "";
          close();
        }

        function render(q) {
          const query = (q || "").trim().toLowerCase();
          const items = [ALL].concat(
            query ? orgs.filter(o => (o.name || "").toLowerCase().includes(query)) : orgs
          );

          list.innerHTML = "";
          const cur = String(hid.value || "");
          for (const it of items) {
            const row = document.createElement("div");
            row.className = "combo-option" + (String(it.id) === cur ? " combo-option--active" : "");
            row.setAttribute("role", "option");
            row.setAttribute("aria-selected", String(it.id) === cur ? "true" : "false");
            row.textContent = it.name;
            row.addEventListener("mousedown", (e) => {
              // mousedown, чтобы не проиграть гонку с blur input
              e.preventDefault();
              setSelected(String(it.id || ""), it.name);
            });
            list.appendChild(row);
          }
        }

        inp.addEventListener("focus", function () {
          open();
        });
        inp.addEventListener("click", function () {
          open();
        });
        inp.addEventListener("input", function () {
          // если вводим руками — считаем что выбор сброшен, пока не кликнули по опции
          hid.value = "";
          open();
        });
        inp.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            e.preventDefault();
            close();
          }
        });

        document.addEventListener("click", function (e) {
          if (!isOpen()) return;
          if (!el.contains(e.target)) close();
        });

        // init: если есть org_id, показываем список для выбранного значения при фокусе
        // (инпут уже заполнен server-side)
      })();
    </script>
    <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>
            <a class="breadcrumb-link" href="/admin/users?{{ base_query }}&page=1&sort=login&dir={% if sort == 'login' and dir == 'asc' %}desc{% else %}asc{% endif %}">
              Логин{% if sort == 'login' %} {% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>ФИО</th>
          <th>
            <a class="breadcrumb-link" href="/admin/users?{{ base_query }}&page=1&sort=is_admin&dir={% if sort == 'is_admin' and dir == 'asc' %}desc{% else %}asc{% endif %}">
              Админ{% if sort == 'is_admin' %} {% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>
            <a class="breadcrumb-link" href="/admin/users?{{ base_query }}&page=1&sort=is_active&dir={% if sort == 'is_active' and dir == 'asc' %}desc{% else %}asc{% endif %}">
              Статус{% if sort == 'is_active' %} {% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th>
            <a class="breadcrumb-link" href="/admin/users?{{ base_query }}&page=1&sort=created_at&dir={% if sort == 'created_at' and dir == 'asc' %}desc{% else %}asc{% endif %}">
              Создан{% if sort == 'created_at' %} {% if dir == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
            </a>
          </th>
          <th class="th-actions-wide"></th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
          <tr>
            <td>{{ u.login }}</td>
            <td>{{ u.full_name }}</td>
            <td>{{ "да" if u.is_admin else "нет" }}</td>
            <td>
              {% if u.is_active %}
                <span class="badge">Активен</span>
              {% else %}
                <span class="badge badge-danger">Заблокирован</span>
              {% endif %}
            </td>
            <td class="mono">{{ u.created_at|dt }}</td>
            <td class="td-actions-wide">
              <div class="row-right" style="justify-content:flex-end">
                <a class="icon-btn" href="/admin/users/{{ u.id }}/edit" title="Редактировать" aria-label="Редактировать">
                  <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm2.92 2.33H5v-.92l9.06-9.06.92.92L5.92 19.58zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/>
                  </svg>
                </a>
                <form method="post" action="/admin/users/{{ u.id }}/toggle_active" style="display:inline">
                  <input type="hidden" name="back" value="{{ current_url }}" />
                  <button class="icon-btn {% if u.is_active %}icon-danger{% endif %}" type="submit" title="{% if u.is_active %}Заблокировать{% else %}Разблокировать{% endif %}" aria-label="{% if u.is_active %}Заблокировать{% else %}Разблокировать{% endif %}">
                    {% if u.is_active %}
                      <!-- lock -->
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 1a5 5 0 0 0-5 5v4H6a2 2 0 0 0-2 2v8a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-8a2 2 0 0 0-2-2h-1V6a5 5 0 0 0-5-5zm-3 9V6a3 3 0 1 1 6 0v4H9z"/>
                      </svg>
                    {% else %}
                      <!-- unlock -->
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M17 8h-1V6a4 4 0 0 0-7.84-1.1l1.9.62A2 2 0 0 1 14 6v2H7a2 2 0 0 0-2 2v9a3 3 0 0 0 3 3h9a3 3 0 0 0 3-3v-9a2 2 0 0 0-2-2zm1 11a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1v-9h11v9z"/>
                      </svg>
                    {% endif %}
                  </button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/delete" style="display:inline" onsubmit="return confirm('Удалить пользователя? Он не сможет входить, а его роли будут удалены.')">
                  <input type="hidden" name="back" value="{{ current_url }}" />
                  <button class="icon-btn icon-danger" type="submit" title="Удалить" aria-label="Удалить">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                      <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm-2 4h10l-1 14H8L7 7zm3 3h2v9h-2v-9zm4 0h2v9h-2v-9z"/>
                    </svg>
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>

    <div class="pagination">
      <div class="muted">Страница {{ page }} из {{ total_pages }}</div>
      <div class="pagination-links">
        {% if has_prev %}
          <a class="btn btn-secondary" href="/admin/users?{{ base_query }}&page=1">⟪</a>
          <a class="btn btn-secondary" href="/admin/users?{{ base_query }}&page={{ page - 1 }}">←</a>
        {% else %}
          <span class="btn btn-secondary" aria-disabled="true">⟪</span>
          <span class="btn btn-secondary" aria-disabled="true">←</span>
        {% endif %}

        {% if page_links[0] > 1 %}
          <span class="muted">…</span>
        {% endif %}
        {% for p in page_links %}
          {% if p == page %}
            <span class="page-chip page-chip-active">{{ p }}</span>
          {% else %}
            <a class="page-chip" href="/admin/users?{{ base_query }}&page={{ p }}">{{ p }}</a>
          {% endif %}
        {% endfor %}
        {% if page_links[-1] < total_pages %}
          <span class="muted">…</span>
        {% endif %}

        {% if has_next %}
          <a class="btn btn-secondary" href="/admin/users?{{ base_query }}&page={{ page + 1 }}">→</a>
          <a class="btn btn-secondary" href="/admin/users?{{ base_query }}&page={{ total_pages }}">⟫</a>
        {% else %}
          <span class="btn btn-secondary" aria-disabled="true">→</span>
          <span class="btn btn-secondary" aria-disabled="true">⟫</span>
        {% endif %}
      </div>
      <form class="pagination-jump" method="get" action="/admin/users">
        {% if selected_org_id %}<input type="hidden" name="org_id" value="{{ selected_org_id }}" />{% endif %}
        {% if filters.login %}<input type="hidden" name="login" value="{{ filters.login }}" />{% endif %}
        {% if filters.full_name %}<input type="hidden" name="full_name" value="{{ filters.full_name }}" />{% endif %}
        <input type="hidden" name="sort" value="{{ sort }}" />
        <input type="hidden" name="dir" value="{{ dir }}" />
        <label style="margin:0">Строк на страницу</label>
        <select name="page_size" style="width: 120px" onchange="this.form.page.value='1'">
          {% for s in [10,20,50,100,200] %}
            <option value="{{ s }}" {% if s == page_size %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
        <label style="margin:0">Перейти</label>
        <input name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" style="width: 110px" />
        <button class="btn btn-secondary" type="submit">Ок</button>
      </form>
    </div>
  </div>
{% endblock %}
