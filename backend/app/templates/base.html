<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "Медлайн.РТК.КБ" }}</title>
    <link rel="stylesheet" href="/static/app.css?v=23" />
    <link rel="icon" href="/static/brand/rtk_mark.svg" type="image/svg+xml" />
  </head>
  <body>
    <div class="topbar">
      <a class="brand" href="/">
        <img
          class="brand-logo"
          src="/static/brand/rtk_full.png"
          alt="Ростелеком"
          onerror="this.onerror=null;this.src='/static/brand/rtk_full.svg';"
        />
      </a>
      {% if user %}
      <div class="topbar-right">
        <span class="muted">Пользователь:</span> {{ user.login }}
        {% if user.is_admin %}
          <span class="badge">admin</span>
        {% endif %}
        <form method="post" action="/logout" style="display:inline">
          <button class="btn btn-secondary" type="submit">Выйти</button>
        </form>
      </div>
      {% endif %}
    </div>
    <div class="{{ container_class or 'container' }}">
      {% block content %}{% endblock %}
    </div>
    <script>
      (function () {
        // marker for debugging cache issues
        window.__dt_localize_v = "dt-localize-v1";
        function pad2(n) { return String(n).padStart(2, '0'); }
        function fmt(d) {
          return (
            d.getFullYear() + '-' +
            pad2(d.getMonth() + 1) + '-' +
            pad2(d.getDate()) + ' ' +
            pad2(d.getHours()) + ':' +
            pad2(d.getMinutes()) + ':' +
            pad2(d.getSeconds())
          );
        }
        document.querySelectorAll('.dt[data-dt-utc]').forEach(function (el) {
          try {
            var iso = el.getAttribute('data-dt-utc');
            if (!iso) return;
            var d = new Date(iso); // ISO with Z => treated as UTC, rendered in local TZ
            if (isNaN(d.getTime())) return;
            el.textContent = fmt(d);
          } catch (e) {}
        });
      })();
    </script>
    <script>
      (function () {
        // Progressive enhancement: searchable org selector from a plain <select>.
        // Opt-in via: <select data-org-autocomplete="1" ...>.
        function initSelectAutocomplete(selectEl) {
          if (!selectEl || selectEl.__autocomplete_inited) return;
          selectEl.__autocomplete_inited = true;

          // Collect options (flatten optgroups)
          var opts = [];
          Array.prototype.forEach.call(selectEl.options || [], function (o) {
            if (!o) return;
            opts.push({ id: String(o.value || ""), label: (o.textContent || "").trim() });
          });

          var combo = document.createElement("div");
          combo.className = "combo";

          var wrap = document.createElement("div");
          wrap.className = "combo-input-wrap";

          var inp = document.createElement("input");
          inp.className = "combo-input";
          inp.type = "text";
          inp.autocomplete = "off";
          inp.placeholder = selectEl.getAttribute("data-placeholder") || "Поиск...";

          var caret = document.createElement("span");
          caret.className = "combo-caret";
          caret.textContent = "▾";

          wrap.appendChild(inp);
          wrap.appendChild(caret);

          var pop = document.createElement("div");
          pop.className = "combo-popover";
          pop.hidden = true;

          var list = document.createElement("div");
          list.className = "combo-list";
          list.setAttribute("role", "listbox");
          pop.appendChild(list);

          combo.appendChild(wrap);
          combo.appendChild(pop);

          // Place combo before select; move select into combo for easier outside-click handling.
          selectEl.parentNode.insertBefore(combo, selectEl);
          combo.appendChild(selectEl);

          // Hide original select only when JS is active (so noscript keeps native select).
          selectEl.style.display = "none";

          function selectedLabel() {
            try {
              var o = selectEl.options[selectEl.selectedIndex];
              return o ? (o.textContent || "").trim() : "";
            } catch (e) {
              return "";
            }
          }

          function open() {
            pop.hidden = false;
            render(inp.value || "");
          }
          function close() {
            pop.hidden = true;
          }
          function isOpen() {
            return pop.hidden === false;
          }

          function setSelected(id, label) {
            selectEl.value = String(id || "");
            inp.value = label || "";
            close();
            if (selectEl.getAttribute("data-auto-submit") === "1" && selectEl.form) {
              try { selectEl.form.submit(); } catch (e) {}
            }
          }

          function render(q) {
            var query = String(q || "").trim().toLowerCase();
            var items = query
              ? opts.filter(function (it) { return (it.label || "").toLowerCase().indexOf(query) >= 0; })
              : opts.slice();

            list.innerHTML = "";
            var cur = String(selectEl.value || "");
            items.forEach(function (it) {
              var row = document.createElement("div");
              row.className = "combo-option" + (String(it.id) === cur ? " combo-option--active" : "");
              row.setAttribute("role", "option");
              row.setAttribute("aria-selected", String(it.id) === cur ? "true" : "false");
              row.textContent = it.label;
              row.addEventListener("mousedown", function (e) {
                e.preventDefault(); // prevent blur before selection
                setSelected(it.id, it.label);
              });
              list.appendChild(row);
            });
          }

          // init input value from current selection
          inp.value = selectedLabel();

          inp.addEventListener("focus", open);
          inp.addEventListener("click", open);
          inp.addEventListener("input", function () {
            // typing does not change selection until click on option
            open();
          });
          inp.addEventListener("keydown", function (e) {
            if (e.key === "Escape") {
              e.preventDefault();
              close();
            }
          });

          document.addEventListener("click", function (e) {
            if (!isOpen()) return;
            if (!combo.contains(e.target)) close();
          });
        }

        document.querySelectorAll("select[data-org-autocomplete='1']").forEach(function (sel) {
          initSelectAutocomplete(sel);
        });
      })();
    </script>
  </body>
</html>
