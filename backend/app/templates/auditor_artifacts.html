{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <div>
      <h2 style="margin:0">Аудит</h2>
      <div class="muted">
        Заполнено: <b>{{ completion_uploaded }}</b> из <b>{{ completion_total }}</b> ({{ completion_pct }}%) · осталось {{ completion_total - completion_uploaded }}
      </div>
      {% if date_from or date_to or org_level %}
        <div class="muted" style="margin-top:4px">
          {% if date_from or date_to %}Диапазон: <b>{{ date_from or '…' }}</b> — <b>{{ date_to or '…' }}</b>{% endif %}
          {% if (date_from or date_to) and org_level %} · {% endif %}
          {% if org_level %}Уровень: <b>{{ org_level.name }}</b>{% endif %}
        </div>
      {% endif %}
    </div>
    <div class="row-right">
      <form method="get" action="/auditor/artifacts" class="header-inline-form org-picker {% if org_required %}org-picker--error{% endif %}">
        <input type="hidden" name="topic" value="{{ topic or '' }}" />
        <input type="hidden" name="domain" value="{{ domain or '' }}" />
        <input type="hidden" name="kb_level" value="{{ kb_level or '' }}" />
        <input type="hidden" name="short_name" value="{{ short_name or '' }}" />
        <input type="hidden" name="q" value="{{ q or '' }}" />
        <input type="hidden" name="status" value="{{ status or '' }}" />
        <input type="hidden" name="level" value="{{ level or '' }}" />
        <input type="hidden" name="in_period" value="{% if in_period %}1{% endif %}" />
        <input type="hidden" name="date_from" value="{{ date_from or '' }}" />
        <input type="hidden" name="date_to" value="{{ date_to or '' }}" />
        <input type="hidden" name="page_size" value="{{ page_size }}" />
        <label style="margin:0">Организация</label>
        <select name="org_id" onchange="this.form.submit()" data-org-autocomplete="1" data-auto-submit="1" data-placeholder="">
          <option value="" {% if not selected_org_id %}selected{% endif %}></option>
          {% for o in orgs %}
            <option value="{{ o.id }}" {% if o.id == selected_org_id %}selected{% endif %}>{{ o.name }}</option>
          {% endfor %}
        </select>
      </form>
      <a class="btn btn-secondary" {% if selected_org_id %}href="/auditor/artifacts/export.xlsx?{{ export_query }}"{% else %}aria-disabled="true"{% endif %}>Выгрузить Excel</a>
      <a class="btn btn-secondary btn-badge" {% if selected_org_id %}href="/auditor/chat?org_id={{ selected_org_id }}"{% else %}aria-disabled="true"{% endif %}>
        Чат
        {% if chat_unread_total and chat_unread_total > 0 %}
          <span class="badge-dot">{{ chat_unread_total }}</span>
        {% endif %}
      </a>
      <a class="btn btn-secondary" {% if selected_org_id %}href="/auditor/dashboards?org_ids={{ selected_org_id }}"{% else %}aria-disabled="true"{% endif %}>Дашборды</a>
      <a class="btn btn-secondary" {% if selected_org_id %}href="/auditor/index-kb?org_id={{ selected_org_id }}"{% else %}aria-disabled="true"{% endif %}>Индекс КБ</a>
      <a class="btn btn-secondary" {% if selected_org_id %}href="/auditor/files?org_id={{ selected_org_id }}"{% else %}aria-disabled="true"{% endif %}>Файлы</a>
      <a class="btn btn-secondary" href="/artifacts">Справочник</a>
    </div>
  </div>

  <div class="card">
    <form method="get" action="/auditor/artifacts" class="grid filter-form filter-form--status filter-form--auditor-artifacts">
      <input type="hidden" name="org_id" value="{{ selected_org_id }}" />
      <input type="hidden" name="page_size" value="{{ page_size }}" />
      <div class="filter-q">
        <label>Поиск (показатель/артефакт)</label>
        <input name="q" value="{{ q or '' }}" placeholder="например: лицензии / конфигурации" />
      </div>
      <div class="filter-topic">
        <label>Тематика</label>
        <select name="topic">
          <option value="">(все)</option>
          {% for t in topics %}
            <option value="{{ t }}" {% if t == topic %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-domain">
        <label>Домен</label>
        <select name="domain">
          <option value="">(все)</option>
          {% for d in domains %}
            <option value="{{ d }}" {% if d == domain %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-kb">
        <label>Уровень КБ</label>
        <select name="kb_level">
          <option value="">(все)</option>
          {% for k in kb_levels %}
            <option value="{{ k }}" {% if k == kb_level %}selected{% endif %}>{{ k }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-kb">
        <label>Уровень (набор)</label>
        <select name="level">
          <option value="" {% if not level %}selected{% endif %}>(все)</option>
          {% for l in levels %}
            <option value="{{ l.code }}" {% if l.code == level %}selected{% endif %}>{{ l.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-status">
        <label>Статус</label>
        <select name="status">
          <option value="" {% if not status %}selected{% endif %}>(все)</option>
          <option value="missing" {% if status == "missing" %}selected{% endif %}>Не загружен</option>
          <option value="uploaded" {% if status == "uploaded" %}selected{% endif %}>Требует аудита</option>
          <option value="needs_correction" {% if status == "needs_correction" %}selected{% endif %}>Требует корректировки</option>
          <option value="changed" {% if status == "changed" %}selected{% endif %}>Изменён после аудита</option>
          <option value="audited" {% if status == "audited" %}selected{% endif %}>Проаудировано</option>
        </select>
      </div>
      <div class="filter-short">
        <label>Сокращенное наименование (точно)</label>
        <input name="short_name" value="{{ short_name or '' }}" placeholder="например: СЗИ.2FA.1" />
      </div>
      <div class="filter-period">
        <label class="muted" style="margin:0">Диапазон</label>
        <div class="filter-period__row">
          <input type="date" name="date_from" value="{{ date_from or '' }}" style="width: 160px;" />
          <span class="muted">—</span>
          <input type="date" name="date_to" value="{{ date_to or '' }}" style="width: 160px;" />
          <label class="filter-meta__label filter-meta__nowrap" style="user-select:none; margin:0">
            <input type="checkbox" name="in_period" value="1" {% if in_period %}checked{% endif %} onchange="this.form.submit()" />
            <span>Только загруженные в диапазоне</span>
          </label>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn" type="submit">Применить</button>
      </div>
      {% if date_range_error %}
        <div class="muted" style="grid-column: 1 / -1; margin-top: 6px; color: #b91c1c;">{{ date_range_error }}</div>
      {% endif %}
    </form>
  </div>

  {% if selected_org_id %}
    <div class="card">
      <div class="section-header">
        <h3>Таблица</h3>
        <div class="muted">Показано {{ rows|length }} из {{ total }} · страница {{ page }} из {{ total_pages }}</div>
        <div class="row-right"></div>
      </div>

      <div class="table-wrap">
        <table class="table">
        <thead>
          <tr>
            <th>Тематика</th>
            <th>Домен</th>
            <th>Сокращенное</th>
            <th>Пункт</th>
            <th>Артефакт</th>
            <th class="col-status">Статус</th>
            <th>Файл</th>
            <th>Дата загрузки</th>
            <th>Кто загрузил</th>
            <th>Дата изменения</th>
            <th>Кто изменил</th>
            <th style="min-width:260px">Комментарий</th>
            <th class="th-actions"></th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td>{{ r.a.topic }}</td>
              <td>{{ r.a.domain }}</td>
              <td class="mono">{{ r.a.short_name }}</td>
              <td class="mono">{% if r.a.achievement_item_no %}{{ r.a.achievement_item_no }}{% else %}—{% endif %}</td>
              <td style="min-width:260px">{{ r.a.title }}</td>
              <td class="col-status">
                {% if not r.oa.current_file_version_id %}
                  <span class="badge badge-danger">Нет файла</span>
                {% elif r.oa.review_status.value == "needs_correction" %}
                  <span class="badge badge-danger">Требует корректировки</span>
                {% elif r.oa.review_status.value == "approved" and r.oa.audited_file_version_id and r.oa.audited_file_version_id == r.oa.current_file_version_id %}
                  <span class="badge">Проаудировано</span>
                  {% if r.oa.audited_at %}
                    <div class="muted mono" style="margin-top:4px">{{ r.oa.audited_at|dt }}</div>
                  {% endif %}
                {% elif r.oa.audited_file_version_id %}
                  <span class="badge badge-warn">Изменён</span>
                {% else %}
                  <span class="badge badge-warn">Требует аудита</span>
                {% endif %}
              </td>
              <td class="mono">{% if r.fv %}{{ r.fv.original_filename }}{% else %}—{% endif %}</td>
              <td class="mono">{% if r.fv %}{{ r.fv.created_at|dt }}{% else %}—{% endif %}</td>
              <td class="mono">{% if r.uploaded_by %}{{ r.uploaded_by }}{% else %}—{% endif %}</td>
              <td class="mono">{% if r.oa.updated_at %}{{ r.oa.updated_at|dt }}{% else %}—{% endif %}</td>
              <td class="mono">{% if r.updated_by %}{{ r.updated_by }}{% else %}—{% endif %}</td>
              <td class="comment-cell">
                <div class="comment-box">
                  <div class="comment-meta">
                    {% if r.comment_text %}
                      Последний: <span class="mono">{{ r.comment_by }}</span> · <span class="mono">{{ r.comment_at|dt }}</span>
                    {% else %}
                      <span class="muted">Комментариев ещё нет.</span>
                    {% endif %}
                  </div>

                  <form method="post" action="/auditor/org_artifacts/{{ r.oa.id }}/comment" class="comment-form">
                    <input type="hidden" name="org_id" value="{{ selected_org_id }}" />
                    <input type="hidden" name="back" value="{{ current_url }}" />
                    <textarea name="comment" rows="2" class="comment-input" placeholder="Комментарий аудитора...">{{ r.comment_text }}</textarea>
                    <div class="comment-actions">
                      <button class="icon-btn" type="submit" title="Сохранить" aria-label="Сохранить">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                          <path fill="currentColor" d="M17 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7l-4-4zM6 8V5h9v3H6z"/>
                          <path fill="currentColor" d="M16 9v6h2l-3 3-3-3h2V9h2z"/>
                        </svg>
                      </button>
                    </div>
                  </form>
                </div>
              </td>
              <td class="td-actions">
                <div class="row-right" style="justify-content:flex-end; align-items:center; gap:8px">
                  <a class="icon-btn" href="/auditor/org_artifacts/{{ r.oa.id }}/history?back={{ current_url|urlencode }}" title="История (версии + действия)" aria-label="История">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                      <path fill="currentColor" d="M13 3a9 9 0 1 0 8.95 10h-2.02A7 7 0 1 1 13 5V2l4 3-4 3V5z"/>
                      <path fill="currentColor" d="M12 8h2v5h4v2h-6V8z"/>
                    </svg>
                  </a>

                  <a class="icon-btn" href="/auditor/org_artifacts/{{ r.oa.id }}/chat" title="Чат по артефакту" aria-label="Чат по артефакту">
                    <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                      <path fill="currentColor" d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
                      <path fill="currentColor" d="M6 6h12v2H6V6zm0 4h9v2H6v-2z"/>
                    </svg>
                    {% if chat_unread_by_oa_id and chat_unread_by_oa_id.get(r.oa.id) %}
                      <span class="icon-btn__badge" title="Непрочитанные: {{ chat_unread_by_oa_id.get(r.oa.id) }}">{{ chat_unread_by_oa_id.get(r.oa.id) }}</span>
                    {% endif %}
                  </a>

                  {% if r.oa.current_file_version_id %}
                    {% if (not r.oa.audited_file_version_id or r.oa.audited_file_version_id != r.oa.current_file_version_id) %}
                      <form method="post" action="/auditor/org_artifacts/{{ r.oa.id }}/audit" style="display:inline">
                        <input type="hidden" name="back" value="{{ current_url }}" />
                        <button class="icon-btn icon-success" type="submit" title="Проверено (проаудировано)" aria-label="Проверено (проаудировано)">
                          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                            <path fill="currentColor" d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
                          </svg>
                        </button>
                      </form>
                    {% endif %}

                    <button
                      class="icon-btn icon-danger"
                      type="button"
                      data-needs-correction-btn="1"
                      data-oa-id="{{ r.oa.id }}"
                      title="Требует корректировки (вернуть заказчику с комментарием)"
                      aria-label="Требует корректировки (вернуть заказчику с комментарием)"
                    >
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm1 15h-2v-2h2zm0-4h-2V7h2z"/>
                      </svg>
                    </button>

                    <a class="icon-btn" href="/auditor/org_artifacts/{{ r.oa.id }}/view?back={{ current_url|urlencode }}" target="_blank" rel="noopener" title="Просмотр" aria-label="Просмотр">
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-8a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
                      </svg>
                    </a>
                    <a class="icon-btn" href="/auditor/org_artifacts/{{ r.oa.id }}/download{% if r.fv %}?fv_id={{ r.fv.id }}{% endif %}" title="Скачать" aria-label="Скачать">
                      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M5 20h14v-2H5v2zm7-18-5.5 5.5 1.42 1.42L11 6.84V16h2V6.84l3.08 3.08 1.42-1.42L12 2z"/>
                      </svg>
                    </a>

                    {% if can_delete_files %}
                      <form method="post" action="/auditor/org_artifacts/{{ r.oa.id }}/delete" style="display:inline" onsubmit="return confirm('Удалить текущий файл? Статус станет \"Не загружен\".')">
                        <input type="hidden" name="back" value="{{ current_url }}" />
                        <button class="icon-btn icon-danger" type="submit" title="Удалить файл" aria-label="Удалить файл">
                          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                            <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm-2 4h10l-1 14H8L7 7zm3 3h2v9h-2v-9zm4 0h2v9h-2v-9z"/>
                          </svg>
                        </button>
                      </form>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
          {% endfor %}
          {% if rows|length == 0 %}
            <tr>
              <td colspan="13" class="muted">
                {% if in_period %}
                  В выбранном периоде нет загруженных файлов (или загрузки не попали в период).
                {% else %}
                  Нет данных по выбранным фильтрам.
                {% endif %}
              </td>
            </tr>
          {% endif %}
        </tbody>
        </table>
      </div>

      {% if total_pages > 1 %}
        <div class="pagination">
        <div class="muted">Страница {{ page }} из {{ total_pages }}</div>
        <div class="pagination-links">
          {% if has_prev %}
            <a class="btn btn-secondary" href="/auditor/artifacts?{{ base_query }}&page=1">⟪</a>
            <a class="btn btn-secondary" href="/auditor/artifacts?{{ base_query }}&page={{ page - 1 }}">←</a>
          {% endif %}

          {% if page_links[0] > 1 %}
            <span class="muted">…</span>
          {% endif %}
          {% for p in page_links %}
            {% if p == page %}
              <span class="page-chip page-chip-active">{{ p }}</span>
            {% else %}
              <a class="page-chip" href="/auditor/artifacts?{{ base_query }}&page={{ p }}">{{ p }}</a>
            {% endif %}
          {% endfor %}
          {% if page_links[-1] < total_pages %}
            <span class="muted">…</span>
          {% endif %}

          {% if has_next %}
            <a class="btn btn-secondary" href="/auditor/artifacts?{{ base_query }}&page={{ page + 1 }}">→</a>
            <a class="btn btn-secondary" href="/auditor/artifacts?{{ base_query }}&page={{ total_pages }}">⟫</a>
          {% endif %}
        </div>

        <form class="pagination-jump" method="get" action="/auditor/artifacts">
          <input type="hidden" name="org_id" value="{{ selected_org_id }}" />
          <input type="hidden" name="topic" value="{{ topic or '' }}" />
          <input type="hidden" name="domain" value="{{ domain or '' }}" />
          <input type="hidden" name="kb_level" value="{{ kb_level or '' }}" />
          <input type="hidden" name="short_name" value="{{ short_name or '' }}" />
          <input type="hidden" name="q" value="{{ q or '' }}" />
          <input type="hidden" name="status" value="{{ status or '' }}" />
          <label style="margin:0">Строк на страницу</label>
          <select name="page_size" onchange="this.form.page.value=1; this.form.submit()" style="width: 140px;">
            {% for s in [10,20,50,100,200] %}
              <option value="{{ s }}" {% if s == page_size %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
          <label style="margin:0">Перейти</label>
          <input name="page" type="number" min="1" max="{{ total_pages }}" value="{{ page }}" style="width: 110px" />
          <button class="btn btn-secondary" type="submit">Ок</button>
        </form>
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="card">
      <div class="muted">Таблица появится после выбора организации.</div>
    </div>
  {% endif %}

  <dialog id="needsCorrectionDialog">
    <form method="post" id="needsCorrectionForm">
      <h3 style="margin-top:0">Требует корректировки</h3>
      <div class="muted" style="margin-bottom:10px">Укажите комментарий аудитора — он будет виден заказчику.</div>
      <input type="hidden" name="back" value="{{ current_url }}" />
      <label>Комментарий</label>
      <textarea name="comment" id="needsCorrectionComment" rows="4" placeholder="Что нужно исправить?" required></textarea>
      <div class="row-right" style="margin-top:12px; gap:8px">
        <button class="btn btn-secondary" type="button" id="needsCorrectionCancel">Отмена</button>
        <button class="btn" type="submit" id="needsCorrectionSubmit" disabled>Вернуть на корректировку</button>
      </div>
    </form>
  </dialog>

  <script>
    (function () {
      var dlg = document.getElementById("needsCorrectionDialog");
      var form = document.getElementById("needsCorrectionForm");
      var ta = document.getElementById("needsCorrectionComment");
      var btn = document.getElementById("needsCorrectionSubmit");
      var cancel = document.getElementById("needsCorrectionCancel");
      if (!dlg || !form || !ta || !btn || !cancel) return;

      function setEnabled() {
        try {
          var v = (ta.value || "").trim();
          btn.disabled = v.length === 0;
        } catch (e) {}
      }
      ta.addEventListener("input", setEnabled);
      setEnabled();

      cancel.addEventListener("click", function () {
        try { dlg.close(); } catch (e) {}
      });

      function openFor(oaId) {
        var id = String(oaId || "").trim();
        if (!id) return;
        form.action = "/auditor/org_artifacts/" + encodeURIComponent(id) + "/needs_correction";
        ta.value = "";
        setEnabled();
        if (typeof dlg.showModal === "function") {
          dlg.showModal();
          ta.focus();
          return;
        }
        // Fallback (very old browsers): use prompt
        var txt = prompt("Комментарий аудитора (обязателен):", "");
        if (!txt) return;
        ta.value = txt;
        setEnabled();
        if (!btn.disabled) {
          try { form.submit(); } catch (e) {}
        }
      }

      document.querySelectorAll("[data-needs-correction-btn='1']").forEach(function (el) {
        el.addEventListener("click", function () {
          openFor(el.getAttribute("data-oa-id"));
        });
      });
    })();
  </script>
{% endblock %}

