{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <div>
      <h2 style="margin:0">Индекс КБ</h2>
      <div class="muted">Формы Индекса КБ. Структура листов хранится в БД (без парсинга Excel при открытии страницы).</div>
    </div>
    <div class="row-right">
      {% set _base = base_prefix or "/auditor" %}
      {% set _files = files_base or (_base ~ "/files") %}
      {% set _art = artifacts_base or (_base ~ "/artifacts") %}
      {% if show_org_selector is not defined or show_org_selector %}
        <form method="get" action="{{ _base }}/index-kb" class="header-inline-form {% if org_picker_error %}org-picker--error{% endif %}">
          <label style="margin:0">Организация</label>
          <select name="org_id" onchange="this.form.submit()" data-org-autocomplete="1" data-auto-submit="1" data-placeholder="">
            <option value="" {% if not selected_org_id %}selected{% endif %}></option>
            {% for o in orgs %}
              <option value="{{ o.id }}" {% if o.id == selected_org_id %}selected{% endif %}>{{ o.name }}</option>
            {% endfor %}
          </select>
          <label style="margin:0">Диапазон</label>
          <input type="date" name="date_from" value="{{ date_from or '' }}" style="width: 160px;" />
          <span class="muted">—</span>
          <input type="date" name="date_to" value="{{ date_to or '' }}" style="width: 160px;" />
        </form>
      {% endif %}
      <a class="btn btn-secondary" {% if selected_org_id %}href="{{ _base }}/dashboards?org_ids={{ selected_org_id }}"{% else %}aria-disabled="true"{% endif %}>Дашборды</a>
      <a class="btn btn-secondary" href="{% if selected_org_id %}{{ _art }}?org_id={{ selected_org_id }}{% else %}{{ _art }}{% endif %}">Артефакты</a>
      <a class="btn btn-secondary" href="{% if selected_org_id %}{{ _files }}?org_id={{ selected_org_id }}{% else %}{{ _files }}{% endif %}">Файлы</a>
      <a class="btn btn-secondary" href="/artifacts">Справочник</a>
    </div>
  </div>

  {% if error %}
    <div class="card">
      <div class="error">{{ error }}</div>
      <div class="hint">Проверьте, что применены миграции Alembic (включая seed‑миграции шаблонов Индекса КБ).</div>
    </div>
  {% else %}
    <div class="card">
      <div class="section-header" style="margin-bottom: 10px">
        <div>
          <h3 style="margin:0">Выбор формы</h3>
        </div>
        <div class="muted">Доступно форм: {{ sheet_names|length }}</div>
      </div>

      <div class="admin-grid indexkb-admin-grid">
        {% set _avail = available_sheets or [] %}
        {% for s in sheet_names %}
          {% if s == "Управление ИБ" %}
            {% if selected_org_id and (s in _avail) %}
              <a class="admin-tile" href="{{ _base }}/index-kb/uib?org_id={{ selected_org_id }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                <div class="admin-tile-icon">
                  <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M7 2h10v2H7V2zm-2 4h14v16H5V6zm3 3h8v2H8V9zm0 4h8v2H8v-2zm0 4h6v2H8v-2z"/>
                  </svg>
                </div>
                <div>
                  <div class="admin-tile-title">Управление ИБ</div>
                  <div class="admin-tile-desc">Автозаполнение КБ1/КБ2/КБ3 по статусу артефактов + ручной ввод.</div>
                </div>
              </a>
            {% else %}
              <div class="admin-tile admin-tile--disabled" aria-disabled="true" title="{% if not selected_org_id %}Выберите организацию{% else %}Шаблон не загружен{% endif %}">
                <div class="admin-tile-icon">
                  <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M7 2h10v2H7V2zm-2 4h14v16H5V6zm3 3h8v2H8V9zm0 4h8v2H8v-2zm0 4h6v2H8v-2z"/>
                  </svg>
                </div>
                <div>
                  <div class="admin-tile-title">Управление ИБ</div>
                  <div class="admin-tile-desc">{% if not selected_org_id %}Выберите организацию{% else %}Шаблон не загружен{% endif %}</div>
                </div>
              </div>
            {% endif %}
          {% elif s == "СЗИ" %}
            {% if selected_org_id and (s in _avail) %}
              <a class="admin-tile" href="{{ _base }}/index-kb/szi?org_id={{ selected_org_id }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                <div class="admin-tile-icon">
                  <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M6 2h9l3 3v17H6V2zm8 1v4h4"/>
                    <path fill="currentColor" d="M8 10h8v2H8v-2zm0 4h8v2H8v-2z"/>
                  </svg>
                </div>
                <div>
                  <div class="admin-tile-title">СЗИ</div>
                  <div class="admin-tile-desc">Автозаполнение по статусу «проаудировано» + ручной ввод.</div>
                </div>
              </a>
            {% else %}
              <div class="admin-tile admin-tile--disabled" aria-disabled="true" title="{% if not selected_org_id %}Выберите организацию{% else %}Шаблон не загружен{% endif %}">
                <div class="admin-tile-icon">
                  <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M6 2h9l3 3v17H6V2zm8 1v4h4"/>
                    <path fill="currentColor" d="M8 10h8v2H8v-2zm0 4h8v2H8v-2z"/>
                  </svg>
                </div>
                <div>
                  <div class="admin-tile-title">СЗИ</div>
                  <div class="admin-tile-desc">{% if not selected_org_id %}Выберите организацию{% else %}Шаблон не загружен{% endif %}</div>
                </div>
              </div>
            {% endif %}
          {% else %}
            <div class="admin-tile admin-tile--disabled" aria-disabled="true" title="В разработке">
              <div class="admin-tile-icon">
                <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
                  <path fill="currentColor" d="M6 2h9l3 3v17H6V2zm8 1v4h4"/>
                  <path fill="currentColor" d="M8 10h8v2H8v-2zm0 4h8v2H8v-2z"/>
                </svg>
              </div>
              <div>
                <div class="admin-tile-title">{{ s }}</div>
                <div class="admin-tile-desc">Скоро</div>
              </div>
              <div class="indexkb-soon-badge">Скоро</div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
{% endblock %}

