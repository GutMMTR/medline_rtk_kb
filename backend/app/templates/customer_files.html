{% extends "base.html" %}
{% block content %}
  <div class="row">
    <div>
      <h2>–§–∞–π–ª—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: {{ org_name }}</h2>
      <div class="muted">–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–∞–ø–∫–∞–º —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ ‚Äú–°–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–≥–æ‚Äù (–Ω–∞–ø—Ä–∏–º–µ—Ä: –í–°–°–¢.–ö–ú–ù–ö.1 ‚Üí –í–°–°–¢/–ö–ú–ù–ö/1).</div>
    </div>
    <div class="row-right">
      {% if orgs and orgs|length > 1 %}
        <form method="get" action="/my/files" style="display:inline">
          <select name="org_id" data-org-autocomplete="1" data-auto-submit="1" data-placeholder="–ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏‚Ä¶">
            {% for o in orgs %}
              <option value="{{ o.id }}" {% if o.id == selected_org_id %}selected{% endif %}>{{ o.name }}</option>
            {% endfor %}
          </select>
        </form>
      {% endif %}
      <a class="btn btn-secondary" href="/my/index-kb?org_id={{ selected_org_id }}">–ò–Ω–¥–µ–∫—Å –ò–ë</a>
      <a class="btn btn-secondary btn-badge" href="/my/chat?org_id={{ selected_org_id }}">
        –ß–∞—Ç
        {% if chat_unread_total and chat_unread_total > 0 %}
          <span class="badge-dot">{{ chat_unread_total }}</span>
        {% endif %}
      </a>
      <a class="btn btn-secondary" href="/my/artifacts">–ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º</a>
    </div>
  </div>

  <div class="card">
    <div class="breadcrumb">
      <a class="breadcrumb-link" href="/my/files?org_id={{ selected_org_id }}">–ö–æ—Ä–µ–Ω—å</a>
      {% for c in crumbs %}
        <span class="muted">/</span>
        <a class="breadcrumb-link" href="/my/files?org_id={{ selected_org_id }}&path={{ c.path }}">{{ c.name }}</a>
      {% endfor %}
    </div>
  </div>

  {% if folders|length > 0 %}
    <div class="card">
      <h3>–ü–∞–ø–∫–∏</h3>
      <div class="folder-grid">
        {% for name, cnt in folders %}
          <a class="folder-card" href="/my/files?org_id={{ selected_org_id }}&path={{ (path ~ '/' if path else '') ~ name }}">
            <div class="folder-icon">üìÅ</div>
            <div class="folder-name mono">{{ name }}</div>
            <div class="muted">—ç–ª–µ–º–µ–Ω—Ç–æ–≤: {{ cnt }}</div>
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if leaf_items|length > 0 %}
    <div class="card">
      <div class="section-header">
        <h3>–§–∞–π–ª—ã / —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</h3>
        <div class="muted">–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω) + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.</div>
      </div>
      <div class="table-wrap">
        <table class="table table-fixed table-customer-files">
          <thead>
            <tr>
              <th>–°–æ–∫—Ä–∞—â–µ–Ω–Ω–æ–µ</th>
              <th>–ü—É–Ω–∫—Ç</th>
              <th>–ê—Ä—Ç–µ—Ñ–∞–∫—Ç</th>
              <th class="col-status">–°—Ç–∞—Ç—É—Å</th>
              <th class="col-status">–ê—É–¥–∏—Ç</th>
              <th>–§–∞–π–ª</th>
              <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
              <th>–ö—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª</th>
              <th>–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</th>
              <th>–ö—Ç–æ –æ–±–Ω–æ–≤–∏–ª</th>
              <th>–ó–∞–≥—Ä—É–∑–∏—Ç—å</th>
              <th class="th-actions-wide"></th>
            </tr>
          </thead>
          <tbody>
            {% for r in leaf_items %}
              <tr>
                <td class="mono">{{ r.a.short_name }}</td>
                <td class="mono">{% if r.a.achievement_item_no %}{{ r.a.achievement_item_no }}{% else %}‚Äî{% endif %}</td>
                <td class="cell-wrap">{{ r.a.title }}</td>
                <td class="col-status">
                  {% if r.oa.status.value == "uploaded" %}
                    <span class="badge">–ó–∞–≥—Ä—É–∂–µ–Ω</span>
                  {% else %}
                    <span class="badge badge-danger">–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω</span>
                  {% endif %}
                </td>
                <td class="col-status">
                  <span
                    class="{{ r.audit_class }}"
                    {% if r.comment_text %}
                      title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞—É–¥–∏—Ç–æ—Ä–∞: {{ r.comment_by }} ¬∑ {{ r.comment_at|dt }}&#10;{{ r.comment_text|replace('\n',' ') }}"
                    {% endif %}
                  >{{ r.audit_label }}</span>
                  {% if r.audit_label == "–ü—Ä–æ–∞—É–¥–∏—Ä–æ–≤–∞–Ω–æ" and r.oa.audited_at %}
                    <div class="muted mono" style="margin-top:4px">{{ r.oa.audited_at|dt }}{% if r.audited_by %} ¬∑ {{ r.audited_by }}{% endif %}</div>
                  {% endif %}
                </td>
                <td class="mono cell-wrap">
                  {% if r.fv %}
                    v{{ r.fv.version_no }} ¬∑ {{ r.fv.original_filename }}
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td class="mono">{% if r.fv %}{{ r.fv.created_at|dt }}{% else %}‚Äî{% endif %}</td>
                <td class="mono">{% if r.uploaded_by %}{{ r.uploaded_by }}{% else %}‚Äî{% endif %}</td>
                <td class="mono">{% if r.oa.updated_at %}{{ r.oa.updated_at|dt }}{% else %}‚Äî{% endif %}</td>
                <td class="mono">{% if r.updated_by %}{{ r.updated_by }}{% else %}‚Äî{% endif %}</td>
                <td>
                  <form method="post" action="/my/artifacts/{{ r.oa.id }}/upload" enctype="multipart/form-data">
                    <div class="upload-row">
                      <input class="file-input" name="upload" type="file" required />
                      <button class="icon-btn icon-success" type="submit" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                          <path fill="currentColor" d="M5 18v2h14v-2H5zM12 3l7 7h-4v6H9v-6H5l7-7z"/>
                        </svg>
                      </button>
                    </div>
                    <div class="file-name muted"></div>
                  </form>
                </td>
                <td class="td-actions-wide">
                  {% if r.oa.status.value == "uploaded" %}
                    <div class="row-right">
                      <a class="icon-btn" href="/my/artifacts/{{ r.oa.id }}/download" title="–°–∫–∞—á–∞—Ç—å" aria-label="–°–∫–∞—á–∞—Ç—å">
                        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                          <path fill="currentColor" d="M5 18v2h14v-2H5zM19 9h-4V3H9v6H5l7 7 7-7z"/>
                        </svg>
                      </a>
                      <form method="post" action="/my/artifacts/{{ r.oa.id }}/delete" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞? –°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω–µ—Ç \"–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω\". –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è.');" style="display:inline">
                        <button class="icon-btn icon-danger" type="submit" title="–£–¥–∞–ª–∏—Ç—å" aria-label="–£–¥–∞–ª–∏—Ç—å">
                          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
                            <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm-2 4h10l-1 14H8L7 7zm3 3h2v9h-2v-9zm4 0h2v9h-2v-9z"/>
                          </svg>
                        </button>
                      </form>
                    </div>
                  {% else %}
                    <span class="muted">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% if folders|length == 0 and leaf_items|length == 0 %}
    <div class="card">
      <div class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤.</div>
    </div>
  {% endif %}
{% endblock %}

